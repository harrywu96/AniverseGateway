"use strict";Object.defineProperty(exports,Symbol.toStringTag,{value:"Module"});require("node:fs");require("node:path");const F=require("./index2.js");require("electron");require("path");require("child_process");require("fs");require("node:http");require("node:https");require("node:zlib");require("node:stream");require("node:buffer");require("node:util");require("node:url");require("node:net");let D=0;const t={START_BOUNDARY:D++,HEADER_FIELD_START:D++,HEADER_FIELD:D++,HEADER_VALUE_START:D++,HEADER_VALUE:D++,HEADER_VALUE_ALMOST_DONE:D++,HEADERS_ALMOST_DONE:D++,PART_DATA_START:D++,PART_DATA:D++,END:D++};let k=1;const T={PART_BOUNDARY:k,LAST_BOUNDARY:k*=2},O=10,m=13,U=32,g=45,w=58,B=97,V=122,q=R=>R|32,_=()=>{};class Y{constructor(i){this.index=0,this.flags=0,this.onHeaderEnd=_,this.onHeaderField=_,this.onHeadersEnd=_,this.onHeaderValue=_,this.onPartBegin=_,this.onPartData=_,this.onPartEnd=_,this.boundaryChars={},i=`\r
--`+i;const n=new Uint8Array(i.length);for(let r=0;r<i.length;r++)n[r]=i.charCodeAt(r),this.boundaryChars[n[r]]=!0;this.boundary=n,this.lookbehind=new Uint8Array(this.boundary.length+8),this.state=t.START_BOUNDARY}write(i){let n=0;const r=i.length;let d=this.index,{lookbehind:A,boundary:E,boundaryChars:H,index:e,state:o,flags:l}=this;const b=this.boundary.length,p=b-1,y=i.length;let a,S;const h=c=>{this[c+"Mark"]=n},s=c=>{delete this[c+"Mark"]},f=(c,P,u,N)=>{(P===void 0||P!==u)&&this[c](N&&N.subarray(P,u))},L=(c,P)=>{const u=c+"Mark";u in this&&(P?(f(c,this[u],n,i),delete this[u]):(f(c,this[u],i.length,i),this[u]=0))};for(n=0;n<r;n++)switch(a=i[n],o){case t.START_BOUNDARY:if(e===E.length-2){if(a===g)l|=T.LAST_BOUNDARY;else if(a!==m)return;e++;break}else if(e-1===E.length-2){if(l&T.LAST_BOUNDARY&&a===g)o=t.END,l=0;else if(!(l&T.LAST_BOUNDARY)&&a===O)e=0,f("onPartBegin"),o=t.HEADER_FIELD_START;else return;break}a!==E[e+2]&&(e=-2),a===E[e+2]&&e++;break;case t.HEADER_FIELD_START:o=t.HEADER_FIELD,h("onHeaderField"),e=0;case t.HEADER_FIELD:if(a===m){s("onHeaderField"),o=t.HEADERS_ALMOST_DONE;break}if(e++,a===g)break;if(a===w){if(e===1)return;L("onHeaderField",!0),o=t.HEADER_VALUE_START;break}if(S=q(a),S<B||S>V)return;break;case t.HEADER_VALUE_START:if(a===U)break;h("onHeaderValue"),o=t.HEADER_VALUE;case t.HEADER_VALUE:a===m&&(L("onHeaderValue",!0),f("onHeaderEnd"),o=t.HEADER_VALUE_ALMOST_DONE);break;case t.HEADER_VALUE_ALMOST_DONE:if(a!==O)return;o=t.HEADER_FIELD_START;break;case t.HEADERS_ALMOST_DONE:if(a!==O)return;f("onHeadersEnd"),o=t.PART_DATA_START;break;case t.PART_DATA_START:o=t.PART_DATA,h("onPartData");case t.PART_DATA:if(d=e,e===0){for(n+=p;n<y&&!(i[n]in H);)n+=b;n-=p,a=i[n]}if(e<E.length)E[e]===a?(e===0&&L("onPartData",!0),e++):e=0;else if(e===E.length)e++,a===m?l|=T.PART_BOUNDARY:a===g?l|=T.LAST_BOUNDARY:e=0;else if(e-1===E.length)if(l&T.PART_BOUNDARY){if(e=0,a===O){l&=~T.PART_BOUNDARY,f("onPartEnd"),f("onPartBegin"),o=t.HEADER_FIELD_START;break}}else l&T.LAST_BOUNDARY&&a===g?(f("onPartEnd"),o=t.END,l=0):e=0;if(e>0)A[e-1]=a;else if(d>0){const c=new Uint8Array(A.buffer,A.byteOffset,A.byteLength);f("onPartData",0,d,c),d=0,h("onPartData"),n--}break;case t.END:break;default:throw new Error(`Unexpected state entered: ${o}`)}L("onHeaderField"),L("onHeaderValue"),L("onPartData"),this.index=e,this.state=o,this.flags=l}end(){if(this.state===t.HEADER_FIELD_START&&this.index===0||this.state===t.PART_DATA&&this.index===this.boundary.length)this.onPartEnd();else if(this.state!==t.END)throw new Error("MultipartParser.end(): stream ended unexpectedly")}}function x(R){const i=R.match(/\bfilename=("(.*?)"|([^()<>@,;:\\"/[\]?={}\s\t]+))($|;\s)/i);if(!i)return;const n=i[2]||i[3]||"";let r=n.slice(n.lastIndexOf("\\")+1);return r=r.replace(/%22/g,'"'),r=r.replace(/&#(\d{4});/g,(d,A)=>String.fromCharCode(A)),r}async function C(R,i){if(!/multipart/i.test(i))throw new TypeError("Failed to fetch");const n=i.match(/boundary=(?:"([^"]+)"|([^;]+))/i);if(!n)throw new TypeError("no or bad content-type header, no multipart boundary");const r=new Y(n[1]||n[2]);let d,A,E,H,e,o;const l=[],b=new F.FormData,p=s=>{E+=h.decode(s,{stream:!0})},y=s=>{l.push(s)},a=()=>{const s=new F.File(l,o,{type:e});b.append(H,s)},S=()=>{b.append(H,E)},h=new TextDecoder("utf-8");h.decode(),r.onPartBegin=function(){r.onPartData=p,r.onPartEnd=S,d="",A="",E="",H="",e="",o=null,l.length=0},r.onHeaderField=function(s){d+=h.decode(s,{stream:!0})},r.onHeaderValue=function(s){A+=h.decode(s,{stream:!0})},r.onHeaderEnd=function(){if(A+=h.decode(),d=d.toLowerCase(),d==="content-disposition"){const s=A.match(/\bname=("([^"]*)"|([^()<>@,;:\\"/[\]?={}\s\t]+))/i);s&&(H=s[2]||s[3]||""),o=x(A),o&&(r.onPartData=y,r.onPartEnd=a)}else d==="content-type"&&(e=A);A="",d=""};for await(const s of R)r.write(s);return r.end(),b}exports.toFormData=C;
