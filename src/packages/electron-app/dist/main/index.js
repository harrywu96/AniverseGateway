"use strict";const s=require("electron"),l=require("path"),p=require("child_process");let e=null,t=null,a=!1;const c=process.env.NODE_ENV==="development";function i(){e=new s.BrowserWindow({width:1200,height:800,minWidth:900,minHeight:600,webPreferences:{preload:l.join(__dirname,"preload.js"),contextIsolation:!0,nodeIntegration:!1},show:!1}),c?(e.loadURL("http://localhost:5173"),e.webContents.openDevTools()):e.loadFile(l.join(__dirname,"../renderer/index.html")),e.on("ready-to-show",()=>{e==null||e.show()}),e.on("closed",()=>{e=null})}function d(){try{let o,r;if(c)o="python",r=l.join(__dirname,"../../../../run_api_server.py");else{const n=process.resourcesPath;o=l.join(n,"backend","python.exe"),r=l.join(n,"backend","run_api_server.py")}console.log("鍚姩Python鍚庣..."),console.log(`Python璺緞: ${o}`),console.log(`鑴氭湰璺緞: ${r}`),t=p.spawn(o,[r]),t.stdout.on("data",n=>{console.log(`Python鍚庣杈撳嚭: ${n}`),n.toString().includes("Application startup complete")&&(a=!0,e==null||e.webContents.send("backend-started"))}),t.stderr.on("data",n=>{console.error(`Python鍚庣閿欒: ${n}`)}),t.on("close",n=>{console.log(`Python鍚庣宸查€€鍑猴紝閫€鍑虹爜: ${n}`),t=null,a=!1,e&&e.webContents.send("backend-stopped",{code:n})})}catch(o){console.error("鍚姩Python鍚庣鏃跺嚭閿?",o)}}function h(){s.ipcMain.handle("select-video",async()=>{if(!e)return null;const o=await s.dialog.showOpenDialog(e,{properties:["openFile"],filters:[{name:"瑙嗛鏂囦欢",extensions:["mp4","mkv","avi","mov","wmv"]}]});return o.canceled||o.filePaths.length===0?null:o.filePaths[0]}),s.ipcMain.handle("upload-video",async(o,r)=>{try{return await(await fetch("http://127.0.0.1:8000/api/videos/upload-local",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({file_path:r,auto_extract_subtitles:!0})})).json()}catch(n){return console.error("涓婁紶瑙嗛鏃跺嚭閿?",n),{success:!1,error:n.message}}}),s.ipcMain.handle("check-backend-status",()=>a)}s.app.whenReady().then(()=>{i(),d(),h(),s.app.on("activate",()=>{s.BrowserWindow.getAllWindows().length===0&&i()})});s.app.on("window-all-closed",()=>{process.platform!=="darwin"&&(t&&(t.kill(),t=null),s.app.quit())});s.app.on("before-quit",()=>{t&&(t.kill(),t=null)});
