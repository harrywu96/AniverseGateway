"use strict";const l=require("electron"),c=require("path"),P=require("child_process"),w=require("fs");function m(o){const s=Object.create(null,{[Symbol.toStringTag]:{value:"Module"}});if(o){for(const r in o)if(r!=="default"){const i=Object.getOwnPropertyDescriptor(o,r);Object.defineProperty(s,r,i.get?i:{enumerable:!0,get:()=>o[r]})}}return s.default=o,Object.freeze(s)}const u=m(w);let e=null,t=null,p=!1;const f=process.env.NODE_ENV==="development";function h(){e=new l.BrowserWindow({width:1200,height:800,minWidth:900,minHeight:600,webPreferences:{preload:c.join(__dirname,"preload.js"),contextIsolation:!0,nodeIntegration:!1},show:!1}),f?(e.loadURL("http://localhost:5173"),e.webContents.openDevTools()):e.loadFile(c.join(__dirname,"../renderer/index.html")),e.on("ready-to-show",()=>{e==null||e.show()}),e.on("closed",()=>{e=null})}function y(){try{let o,s;if(f){if(process.platform==="win32"){const a=c.join(process.cwd(),"..","..",".venv","Scripts","python.exe");u.existsSync(a)?(console.log(`使用虚拟环境Python: ${a}`),o=a):(console.log("未找到虚拟环境，使用系统Python"),o="python")}else o="python";const g=[c.join(process.cwd(),"..","..","run_api_server.py"),c.join(__dirname,"../../../../run_api_server.py"),c.join(process.cwd(),"run_api_server.py")];console.log("搜索API服务器脚本路径..."),console.log(`当前工作目录: ${process.cwd()}`),s="";for(const a of g)if(console.log(`检查路径: ${a}`),u.existsSync(a)){s=a,console.log(`找到API服务器脚本: ${s}`);break}s||(console.error("错误: 无法找到API服务器脚本"),s=c.join(__dirname,"../../../../run_api_server.py"),console.log(`使用默认路径: ${s}`))}else{const n=process.resourcesPath;o=c.join(n,"backend","python.exe"),s=c.join(n,"backend","run_api_server.py")}console.log("启动Python后端..."),console.log(`Python路径: ${o}`),console.log(`脚本路径: ${s}`);const r={...process.env,PYTHONIOENCODING:"utf-8"},i=process.env.API_PORT||"8000";r.API_PORT=i,t=P.spawn(o,[s],{env:r,windowsHide:!1});let d=setTimeout(()=>{p||(console.error("后端启动超时"),e&&e.webContents.send("backend-error",{message:"后端启动超时，请检查日志以获取详细信息"}))},3e4);t.stdout.on("data",n=>{console.log(`Python后端输出: ${n}`),n.toString().includes("Application startup complete")&&(p=!0,clearTimeout(d),e==null||e.webContents.send("backend-started"))}),t.stderr.on("data",n=>{console.error(`Python后端错误: ${n}`),(n.toString().includes("address already in use")||n.toString().includes("Address already in use"))&&(console.error(`错误: 端口${i}已被占用，请确保没有其他API服务器实例正在运行`),e&&e.webContents.send("backend-error",{message:`端口${i}已被占用，请确保没有其他API服务器实例正在运行`}))}),t.on("close",n=>{console.log(`Python后端已退出，退出码: ${n}`),clearTimeout(d),t=null,p=!1,e&&e.webContents.send("backend-stopped",{code:n})}),t.on("error",n=>{console.error(`启动Python进程时出错: ${n.message}`),clearTimeout(d),e&&e.webContents.send("backend-error",{message:`启动Python进程失败: ${n.message}`})})}catch(o){console.error("启动Python后端时出错",o),e&&e.webContents.send("backend-error",{message:`启动Python后端出错: ${o.message}`})}}function _(){l.ipcMain.handle("select-video",async()=>{if(!e)return null;const o=await l.dialog.showOpenDialog(e,{properties:["openFile"],filters:[{name:"视频文件",extensions:["mp4","mkv","avi","mov","wmv"]}]});return o.canceled||o.filePaths.length===0?null:o.filePaths[0]}),l.ipcMain.handle("upload-video",async(o,s)=>{try{const r=process.env.API_PORT||"8000";return await(await fetch(`http://127.0.0.1:${r}/api/videos/upload-local`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({file_path:s,auto_extract_subtitles:!0})})).json()}catch(r){return console.error("上传视频时出错",r),{success:!1,error:r.message}}}),l.ipcMain.handle("check-backend-status",()=>p),l.ipcMain.handle("restart-backend",()=>{try{return t&&(t.kill(),t=null),y(),{success:!0}}catch(o){return console.error("重启后端时出错",o),{success:!1,error:o.message}}})}l.app.whenReady().then(()=>{h(),y(),_(),l.app.on("activate",()=>{l.BrowserWindow.getAllWindows().length===0&&h()})});l.app.on("window-all-closed",()=>{process.platform!=="darwin"&&(t&&(t.kill(),t=null),l.app.quit())});l.app.on("before-quit",()=>{t&&(t.kill(),t=null)});
